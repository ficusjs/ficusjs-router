const waitFor=(t=(()=>!0),e=1e4)=>new Promise(((r,o)=>{const check=()=>{const s=t();s?r(s):(e-=100)<0?o(new Error("Timed out waiting!")):setTimeout(check,100)};setTimeout(check,100)}));function isPromise(t){return("object"==typeof t||"function"==typeof t)&&"function"==typeof t.then}function hasKey(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function elementEmpty(t){for(;t.firstChild;)t.removeChild(t.firstChild)}function renderOutlet(t,e){const r="string"==typeof e?document.querySelector(e):e;if(!r)return void console.warn(`Unable to find outlet: ${e}`);let o;if(function(t){return t instanceof Element||t instanceof HTMLElement}(t))o=t;else{o=window.customElements.get(t)?document.createElement(t):function(t){const e=document.createElement("div");return e.innerHTML=t.trim(),e.firstChild}(t)}elementEmpty(r),r.appendChild(o);const s="data-router-outlet";r.hasAttribute(s)||r.setAttribute(s,"")}let t=class extends Array{peek(){return this[this.length-1]}};function flatten(t,e,r,o=!0){r.forEach((r=>{if(r.children)!function(t,e,r){let o,s=[...r.children];if(r.action||r.component)o={...r},delete o.children;else{const t=s.find((t=>""===t.path));t&&(o={...t},o.path=r.path,delete o.children,s=s.filter((t=>""!==t.path)))}const n=copyRouteAndAdjustPath(o,e);t.push(n),e.push(n),flatten(t,e,s,!1)}(t,e,r);else{const o=copyRouteAndAdjustPath(r,e);t.push(o)}o&&e.splice(0,e.length)}))}function copyRouteAndAdjustPath(t,e){const r={...t},o=e.peek();return o&&(r.path=`${o.path}${r.path}`),r}function stripTrailingSlash(t){return"/"===t.charAt(t.length-1)?t.slice(0,-1):t}function addMatcherToRoute(t){const e={...t,matcher:e=>stripTrailingSlash(t.path)===stripTrailingSlash(e)?e:void 0};if(t.component&&!t.action&&(e.action=()=>t.component),/:[^/]+/.test(t.path)){const r=t.path.match(/(:[^/]+)/gm);r&&r.length>0&&(e.urlParamKeys=r.map((t=>t.substring(1))));const o=stripTrailingSlash(t.path.replace(/:[^/]+/g,"([^/]+)"));e.pathRegex=new RegExp(`^${o}$`),e.pathRegexCapture=new RegExp(o,"gm"),e.matcher=t=>{if(e.pathRegex.test(t)){const r={};let o;for(;null!==(o=e.pathRegexCapture.exec(t));)if(o&&o.length===e.urlParamKeys.length+1){const t=o.slice(1);for(let o=0;o<t.length;o++)r[e.urlParamKeys[o]]=t[o]}return r}}}return e}class e{constructor(t){let e,r;this.urlParamMap={};let o=[];t.includes("?")?(e=t.substring(t.indexOf("?")+1),e.includes("#")&&(e=e.substring(0,e.indexOf("#")),r=e.substring(e.indexOf("#")+1))):t.includes("#")&&(e="",r=t.substring(t.indexOf("#")+1,t.length)),o=e?e.split("&"):[],r&&r.includes("&")&&r.includes("=")&&(o=[...o,...r.split("&")]);for(let t=0;t<o.length;t++){const e=o[t].split("=");2===e.length&&(this.urlParamMap[e[0]]=this._esc(decodeURIComponent(e[1])))}}entries(){let t=[];for(const e in this.urlParamMap)this.has(e)&&t.push([e,this.urlParamMap[e]]);return t=t.sort((function(t,e){return t[0].toLowerCase()>e[0].toLowerCase()?1:t[0].toLowerCase()<e[0].toLowerCase()?-1:0})),t}remove(t){delete this.urlParamMap[t]}get(t){return this.urlParamMap[t]}has(t){return this.urlParamMap.hasOwnProperty(t)}keys(){const t=[];for(const e in this.urlParamMap)this.has(e)&&t.push(e);return t}set(t,e){this.urlParamMap[t]=e}toString(){let t="";const e=this.entries();for(let r=0;r<e.length;r++){const o=e[r];this.has(o[0])&&(t+="&"+o[0]+"="+encodeURIComponent(this._unesc(o[1])))}return t.substring(1)}values(){const t=[];for(const e in this.urlParamMap)this.has(e)&&t.push(this.urlParamMap[e]);return t}_esc(t){return String(t).replace(/</g,"&lt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/>/g,"&gt;").replace(/&/g,"&amp;")}_unesc(t){return String(t).replace(/&lt;/g,"<").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&amp;/g,"&")}}class r{constructor(){this.items=[]}push(t){this.items.push(t)}pop(){this.items.pop()}peek(){return this.items[this.items.length-1]}isEmpty(){return 0===this.items.length}clear(){this.items=[]}size(){return this.items.length}}class o{constructor(t,e,o){if("undefined"!=typeof window&&window.__ficusjs__&&window.__ficusjs__.router)return window.__ficusjs__.router;this._rootOutletSelector=e,this.stack=new r,this._routes=this._processRoutes(t),this._routerOptions=this._processOptions(o),this._outletCache=new WeakMap,"undefined"!=typeof window&&(window.addEventListener("popstate",(()=>{this._findAndRenderRoute(this.location).then((()=>this.stack.pop())).catch((t=>{throw this._renderError(this.location,t),t}))})),window.__ficusjs__=window.__ficusjs__||{},window.__ficusjs__.router=window.__ficusjs__.router||this)}get location(){let t;return"undefined"!=typeof window&&(t={host:window.location.host,protocol:window.location.protocol,pathname:window.location.pathname,hash:window.location.hash,href:window.location.href,search:window.location.search,state:window.history.state},"hash"===this._routerOptions.mode&&(t.pathname=this._getHashPathname(),t.hash="")),t}get options(){return this._routerOptions}setOptions(t={}){this._routerOptions=this._processOptions(t)}addRoutes(t){this._routes=[...this._routes,...this._processRoutes(t)]}hasRoute(t){return!!this._findRoute(t)}_getQueryStringParams(t){return Object.fromEntries(new e(t.href).entries())}_getUrlParams(t,e){const r=e.matcher(t.pathname);return"string"==typeof r?void 0:r}_findRoute(t){return this._routes.find((e=>void 0!==e.matcher(t)))}_getHashPathname(){let t=window.location.hash.substring(1);return""===t&&(t="/"),t}_processRoutes(e){return function(e){const r=new t;return flatten(r,new t,e),r}(e).map((t=>addMatcherToRoute(t)))}_processOptions(t={}){const e=this,r={mode:"history",autoStart:!0,changeHistoryState:!0,warnOnMissingOutlets:!1,...t};if(!r.resolveRoute)return{...r,resolveRoute(t,r){if(t.route&&"function"==typeof t.route.action)return{template:new Promise(((e,o)=>{e(t.route.action(t,r))})).catch((r=>{throw e._renderError(t.location,r),r})),outlets:t.route.outlets}}};if(r.resolveRoute){const t=r.resolveRoute;return{...r,resolveRoute:(e,r)=>t(e,r)}}return r}_render(t,e,r,o={}){return isPromise(r)?r.then((r=>this._performRender(t,e,r,o))):this._performRender(t,e,r,o)}_performRender(t,e,r,o){return"object"==typeof r&&r.redirect?Promise.resolve(r):r instanceof Error?(this._renderError(t,r),Promise.resolve(!0)):!1===r?Promise.resolve(!1):waitFor((()=>document.querySelector(this._rootOutletSelector))).then((()=>{const t=document.querySelector(this._rootOutletSelector),s=Object.keys(o),n=document.querySelectorAll("[data-router-outlet]:not([sticky])");return n.length&&[...n].filter((e=>e!==t)).forEach((t=>elementEmpty(t))),this._renderIntoOutlet(r,t),s.length?Promise.all(s.map((t=>waitFor((()=>{const e=document.querySelectorAll(t);return e.length>0&&e})).then((r=>{const s=o[t](e,e&&e.params);isPromise(s)?s.then((t=>this._renderIntoAllOutlets(t,r))):this._renderIntoAllOutlets(s,r)})).catch((t=>this._routerOptions.warnOnMissingOutlets&&console.warn(t)))))).then((()=>!0)):Promise.resolve(!0)}))}_renderIntoOutlet(t,e){t&&(this._isSameOutletContent(t,e)||(renderOutlet(t,e),this._outletCache.set(e,t),this._emitRouterOutletChangeEvent(e)))}_renderIntoAllOutlets(t,e){for(let r=0;r<e.length;r++){const o=e[r];this._renderIntoOutlet(t,o)}}_emitRouterOutletChangeEvent(t){!function(t,e,r={}){const o=Object.assign({},{bubbles:!0,cancelable:!0,composed:!1},r),s=new CustomEvent(e,o);t.dispatchEvent(s)}(t,"outlet-change",{detail:{outlet:t}})}_isSameOutletContent(t,e){return!("string"!=typeof t||!this._outletCache.has(e)||this._outletCache.get(e)!==t)}push(t,e){return this._navigate(t,e)}replace(t,e){return this._navigate(t,e,!0)}_navigate(t,e,r=!1){const o=this._normalizeLocation(t);if(!r&&o.pathname===this.location.pathname)return Promise.resolve();const{actionResult:s,context:n}=this._resolveRoute(o);if(null==s){this._routerOptions.changeHistoryState&&this._setState(o.href,e,r);const t=new Error("not_found");return this._renderError(o,t),Promise.reject(t)}if("object"==typeof s&&s.redirect){const e={from:t};return s.redirect!==this.location.pathname?this.push(s.redirect,e):Promise.resolve()}return s instanceof Error?(this._routerOptions.changeHistoryState&&this._setState(o.href,e,r),this._renderError(o,s),Promise.reject(s)):!1===s?Promise.resolve():this._renderActionResult(o,n,s,e,r).then((t=>{if("object"==typeof t&&t.redirect){const e={from:o.href};return this.push(t.redirect,e)}return t&&this._routerOptions.changeHistoryState&&this._setState(o.href,e,r),Promise.resolve(t)})).catch((t=>{throw this._renderError(o,t),t}))}_normalizeLocation(t){const e={host:void 0,protocol:void 0,href:void 0,pathname:void 0,search:void 0,hash:void 0};if("object"==typeof t){if("history"===this._routerOptions.mode&&!t.pathname)throw new Error(`Unable to navigate to: ${t}`);let r=t.href||this.location.href;e.pathname=t.pathname||this.location.pathname,t.search&&""!==t.search&&!r.includes(t.search)&&(r=`${r}${t.search}`,e.search=t.search),t.hash&&""!==t.hash&&!r.includes(t.hash)&&(r=`${r}${t.hash}`,e.hash=t.hash),e.hash=t.hash||this.location.hash,e.search=t.search||this.location.search,e.host=t.host||this.location.host,e.protocol=t.protocol||this.location.protocol,e.href=r}else if("string"==typeof t){const r=new URL(/^https?:\/\//.test(t)?t:`${window.location.protocol}//${window.location.host}${t}`);e.host=r.host,e.protocol=r.protocol,e.href=r.href,e.pathname=r.pathname,e.search=r.search,e.hash=r.hash,t.includes("?")?(e.pathname=t.substring(0,t.indexOf("?")),e.search=t.substring(t.indexOf("?"))):t.includes("#")&&(e.pathname=t.substring(0,t.indexOf("#")))}return"hash"===this._routerOptions.mode&&(e.href=`${window.location.pathname}${e.search||""}#${e.pathname}`),e}_renderActionResult(t,e,r){if(hasKey(r,"template")&&hasKey(r,"outlets")){const{template:o,outlets:s}=r;return this._render(t,e,o,s)}return this._render(t,e,r,{})}_getRouteContext(t,e){let r={...this._getQueryStringParams(e)};const o={context:this._routerOptions.context,router:this,route:t,location:e,params:r};return t&&(r={...r,...this._getUrlParams(e,t)},o.params=r),o}_resolveRoute(t){const e=this._findRoute(t.pathname),r=this._getRouteContext(e,t);try{const t=this._routerOptions.resolveRoute(r,r.params);return null!=t?{actionResult:t,context:r}:e?{actionResult:e.action(r,r.params),context:r}:{actionResult:void 0,context:r}}catch(e){throw this._renderError(t,e),e}}_findAndRenderRoute(t){const{actionResult:e,context:r}=this._resolveRoute(t);if(!e)throw new Error("not_found");return this._renderActionResult(t,r,e)}_setState(t,e,r=!1){r?window.history.replaceState(e,null,t):(this.stack.push(t),window.history.pushState(e,null,t))}_renderError(t,e){if(console.error(`A router error occurred for location '${t.href}'`,e),this._routerOptions.errorHandler){const r={message:e.message,status:"not_found"===e.message?404:500},o=this._getRouteContext(this._findRoute(t.pathname),t),s=this._routerOptions.errorHandler(r,o);isPromise(s)?s.then((e=>this._render(t,o,e))).catch((r=>this._render(t,o,`<div><strong>Router error from <code>errorHandler</code></strong>: ${r.message}, original error: ${e.message}</div>`))):this._render(t,o,s)}else this._render(t,null,`<div><strong>Router error</strong>: ${e.message}</div>`)}go(t){window.history.go(t)}goBack(){this.go(-1)}goForward(){this.go(1)}start(t=this.location){/complete|interactive|loaded/.test(document.readyState)?this.replace(t):document.addEventListener("DOMContentLoaded",(()=>this.replace(t)))}}function createRouter(t,e,r={}){const s=new o(t,e,r);return s.options.autoStart&&s.start(),s}function getRouter(){if("undefined"!=typeof window&&window.__ficusjs__&&window.__ficusjs__.router)return window.__ficusjs__.router}export{addMatcherToRoute,createRouter,getRouter};
